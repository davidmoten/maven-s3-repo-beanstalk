# maven-s3-repo-beanstalk
Private maven repository backed by AWS S3 storage running on AWS Beanstalk

## How to deploy
You need to 
* set credentials (BasicAuth username and password for the service)
* install certificates
* run deploy.sh

## How to set credentials
When the application starts up the file `/authentication.properties` is loaded from the classpath with the authentication details. The password is not stored there, just an HMAC hash. 

To regenerate `authentication.properties` with new authentication details, run this:

    mvn test -Duser=<USER> -Dpassword=<PASSWORD>

The file `src/main/resources/authentication.properties` will be overwritten and you should commit that to source control and then redeploy the application.

### Generate self-signed certificates:
Assuming you don't have certificates for this maven server ready to go:
* Edit `update-certificates.sh` with your certificate fields (in two places)
* Run `/update-certificates.sh` to generate certificates (a zip file is placed in `target`)

### Install certificates
* Create an s3 bucket, *maven-repo-keys-$MODE* and copy across to it the files `server.pem` and `server-private-key.pem` generated by `/update-certificates.sh`
* Set the bucket policy for *maven-repo-keys-$MODE* to this (make sure you replace ${mode} with its actual value):

```json
{
  "Version":"2012-10-17",
  "Statement":[
    {
      "Effect":"Allow",
      "Principal": {"AWS": ["arn:aws:iam:::role/maven-repo-instance-role-${mode}"]},
      "Action":["s3:ListBucketVersions","s3:ListBucket","s3:GetObjectVersion","s3:GetObject"],
      "Resource":["arn:aws:s3:::maven-repo-keys-${mode}/*","arn:aws:s3:::maven-repo-keys-${mode}"],
    }
  ]
}
```
### Run deploy.sh

To deploy, call:

    ./deploy.sh <MODE> 

If you are behind a proxy:

    ./deploy.sh <MODE> -Dhttps.proxyHost=proxy -Dhttps.proxyPort=8080
    
## How to access
The application is accessible at https://<BEANSTALK_ENVIRONMENT_URL>/repo and is 
authenticated using basic authentication. The default credentials are user=me, password=changeit.


 
